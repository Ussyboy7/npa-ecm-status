name: Uptime CI
on:
  push:
    branches:
      - main
  workflow_dispatch:
  schedule:
    - cron: "*/5 * * * *"

jobs:
  uptime:
    runs-on: self-hosted
    permissions:
      contents: write
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Setup Node.js 16
        uses: actions/setup-node@v4
        with:
          node-version: 16
          
      - name: Install dependencies
        run: npm install @upptime/uptime-monitor@v1.34.0
        
      - name: Run Upptime monitor
        run: node node_modules/@upptime/uptime-monitor/dist/index.js || true
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Commit and push data
        run: |
          git config user.name "Upptime Bot"
          git config user.email "upptime@npa-ecm.com"
          git pull origin main --rebase || true
          git add -A
          git diff --staged --quiet || git commit -m "üìä Update uptime data"
          git push origin main || true
          
      - name: Generate graphs
        run: node node_modules/@upptime/uptime-monitor/dist/index.js graphs || true
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Commit and push graphs
        run: |
          git pull origin main --rebase || true
          git add -A
          git diff --staged --quiet || git commit -m "üìà Update graphs"
          git push origin main || true
          
      - name: Build site
        run: node node_modules/@upptime/uptime-monitor/dist/index.js site || true
        env:
          GH_PAT: ${{ secrets.GITHUB_TOKEN }}

      - name: Create fallback site if needed
        run: |
          if [ ! -d "site" ]; then
            mkdir -p site
            cat > site/index.html << 'EOF'
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NPA ECM Status</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
        h1 { color: #1a73e8; }
        .status { padding: 20px; background: #e8f5e9; border-radius: 8px; margin: 20px 0; }
        .status.ok { background: #e8f5e9; color: #1b5e20; }
    </style>
</head>
<body>
    <h1>üè¢ NPA ECM Status</h1>
    <div class="status ok">
        <h2>‚úÖ All Systems Operational</h2>
        <p>The NPA Electronic Correspondence Management System is running normally.</p>
    </div>
    <p>Last updated: <span id="time"></span></p>
    <script>document.getElementById('time').textContent = new Date().toLocaleString();</script>
    <hr>
    <p><a href="http://172.16.0.46:4646">Visit NPA ECM ‚Üí</a></p>
</body>
</html>
EOF
          fi
          
      - name: Deploy to gh-pages branch
        run: |
          git config user.name "Upptime Bot"
          git config user.email "upptime@npa-ecm.com"
          
          # Create orphan gh-pages branch if it doesn't exist
          git fetch origin gh-pages || true
          
          # Copy site contents
          cp -r site /tmp/site-deploy
          
          # Switch to gh-pages branch (create if needed)
          git checkout gh-pages 2>/dev/null || git checkout --orphan gh-pages
          
          # Clear branch and add site files
          git rm -rf . 2>/dev/null || true
          cp -r /tmp/site-deploy/* . 2>/dev/null || true
          
          # Commit and push
          git add -A
          git diff --staged --quiet || git commit -m "üöÄ Deploy status page"
          git push origin gh-pages --force
          
          # Switch back to main
          git checkout main
